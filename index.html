<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kontrol Motor ESP32</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== Reset & Body ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
    }
    h1 {
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 20px 0; width: 100%;
      font-size: 28px; font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      backdrop-filter: blur(6px);
      margin-bottom: 20px;
    }

    /* ===== Motors & Charts ===== */
    .motors-container { display: flex; gap:60px; flex-wrap: wrap; margin:0 20px 40px; }
    .motor-group {
      background: rgba(255,255,255,0.12);
      border-radius: 20px; backdrop-filter: blur(10px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 24px 30px;
      max-width: 360px; flex:1 1 360px;
      display: flex; flex-direction: column; align-items: center;
      border: 1px solid rgba(255,255,255,0.25);
    }
    .motor-group h2 { margin-bottom:20px; font-size:22px; font-weight:700; }
    .speedometer-container { position: relative; width:180px; height:140px; margin-bottom:32px; }
    .speedometer-label {
      position:absolute; bottom:8px; width:100%;
      text-align:center; font-size:16px; font-weight:600;
    }
    .chart-container {
      width:320px; height:180px;
      background: rgba(255,255,255,0.1);
      border-radius:12px; padding:10px; margin-bottom:30px;
    }

    /* ===== Voice Command ===== */
    .voice-container {
      background: rgba(255,255,255,0.12);
      border-radius:20px; backdrop-filter: blur(10px);
      box-shadow:0 8px 20px rgba(0,0,0,0.2);
      padding:24px 30px; max-width:780px; width:100%;
      border:1px solid rgba(255,255,255,0.25);
      margin-bottom:40px;
      display:flex; flex-direction:column; align-items:center; gap:16px;
    }
    .voice-command {
      display:flex; justify-content:center; align-items:center; gap:20px; width:100%;
    }
    .voice-command button {
      background:#fff; color:#1e3c72; font-size:16px;
      padding:12px 24px; border:none; border-radius:30px;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition:background .2s;
    }
    .voice-command button:hover { background:#e3e3e3; }
    .speech-preview {
      font-size:16px; background:rgba(255,255,255,0.2);
      border-radius:10px; padding:10px 20px; min-width:180px;
      text-align:center; border:1px solid rgba(255,255,255,0.3);
    }

    /* ===== Joystick ===== */
    .joystick-container {
      background: rgba(255,255,255,0.12);
      border-radius:20px; backdrop-filter: blur(10px);
      box-shadow:0 8px 20px rgba(0,0,0,0.2);
      padding:24px; max-width:300px; text-align:center; margin-bottom:40px;
    }
    #joystick {
      background: rgba(255,255,255,0.1);
      border-radius:50%; touch-action:none; cursor:pointer;
    }
    #joystickStatus { margin-top:12px; font-weight:600; }

    /* ===== Responsif ===== */
    @media (max-width:800px) {
      .motors-container { gap:20px; }
      .voice-container, .joystick-container { max-width:360px; }
      .chart-container { width:260px; }
    }
  </style>
</head>
<body>
  <h1>ESP32 Motor Control Panel</h1>

  <!-- Grafik Motor -->
  <div class="motors-container">
    <section class="motor-group">
      <h2>Motor Kiri</h2>
      <div class="speedometer-container">
        <canvas id="speedometerLeft" width="180" height="140"></canvas>
        <div class="speedometer-label">(m/s)</div>
      </div>
      <div class="chart-container"><canvas id="rpmLeft"></canvas></div>
      <div class="chart-container"><canvas id="pwmLeft"></canvas></div>
    </section>
    <section class="motor-group">
      <h2>Motor Kanan</h2>
      <div class="speedometer-container">
        <canvas id="speedometerRight" width="180" height="140"></canvas>
        <div class="speedometer-label">(m/s)</div>
      </div>
      <div class="chart-container"><canvas id="rpmRight"></canvas></div>
      <div class="chart-container"><canvas id="pwmRight"></canvas></div>
    </section>
  </div>

  <!-- Voice Command -->
  <div class="voice-container">
    <div class="voice-command">
      <button onclick="startVoiceRecognition()">ðŸŽ¤ Voice Command</button>
      <div id="speechOutput" class="speech-preview">...</div>
    </div>
  </div>

  <!-- Joystick -->
  <div class="joystick-container">
    <h2>Kontrol Joystick</h2>
    <canvas id="joystick" width="240" height="240"></canvas>
    <div id="joystickStatus">(0, 0)</div>
  </div>

  <script>
    // ===== MQTT Setup =====
    const client = mqtt.connect(
      'wss://7a3adf123d584eb0b1c891a0cb842c35.s1.eu.hivemq.cloud:8884/mqtt',
      { username:'isp32', password:'ISPsogem22', connectTimeout:5000, clean:true, protocol:'wss' }
    );
    client.on('connect', ()=>{
      console.log('Terhubung ke MQTT');
      ['motor/rpm/left','motor/rpm/right','motor/pwm/left','motor/pwm/right']
        .forEach(t=>client.subscribe(t));
    });
    function sendCommand(cmd){
      client.publish('motor/mode_pid', cmd);
      console.log('Kirim:', cmd);
    }

    // ===== Charts =====
    function createChart(id,label){
      const ctx = document.getElementById(id).getContext('2d');
      return new Chart(ctx,{
        type:'line',
        data:{ labels:[], datasets:[{ label, borderColor:'#fff',
          backgroundColor:'rgba(255,255,255,0.2)', borderWidth:2,
          pointRadius:0, fill:true, data:[], tension:0.3 }]},
        options:{
          responsive:true, animation:false,
          scales:{ x:{display:false}, y:{ beginAtZero:true, ticks:{color:'#fff'} } },
          plugins:{ legend:{ labels:{ color:'#fff' } } }
        }
      });
    }
    const rpmLeft  = createChart('rpmLeft','RPM Kiri');
    const rpmRight = createChart('rpmRight','RPM Kanan');
    const pwmLeft  = createChart('pwmLeft','PWM Kiri');
    const pwmRight = createChart('pwmRight','PWM Kanan');
    function updateChart(ch,val){
      const now = new Date().toLocaleTimeString();
      ch.data.labels.push(now); ch.data.datasets[0].data.push(Number(val));
      if(ch.data.labels.length>20){
        ch.data.labels.shift(); ch.data.datasets[0].data.shift();
      }
      ch.update();
    }

    // ===== Speedometer =====
    const MAX_SPEED = (100*0.204204)/60;
    const centerTextPlugin = {
      id:'centerText', afterDraw(c){
        const {ctx, chartArea:{width,height}} = c;
        ctx.save();
        ctx.font='bold 28px Segoe UI'; ctx.fillStyle='#fff';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        const sp = c.data.datasets[0].data[0]||0;
        ctx.fillText(sp.toFixed(2)+' m/s', width/2, height/1.7);
        ctx.restore();
      }
    };
    function createSpeedo(id){
      const ctx = document.getElementById(id).getContext('2d');
      return new Chart(ctx,{
        type:'doughnut',
        data:{ labels:['Kecepatan','Sisa'], datasets:[{
          data:[0,MAX_SPEED],
          backgroundColor:['#fff','#444'], borderWidth:0,
          cutout:'80%', circumference:180, rotation:270, hoverOffset:0
        }]},
        options:{ responsive:false, animation:{duration:300},
          plugins:{ tooltip:{enabled:false}, legend:{display:false}, centerText:{} }
        },
        plugins:[centerTextPlugin]
      });
    }
    const speedLeft  = createSpeedo('speedometerLeft');
    const speedRight = createSpeedo('speedometerRight');
    function updateSpeedo(ch,rpm){
      const sp = Math.max(0,Math.min(MAX_SPEED,(rpm*0.204204)/60));
      ch.data.datasets[0].data[0] = sp;
      ch.data.datasets[0].data[1] = MAX_SPEED - sp;
      ch.update();
    }

    // ===== MQTT Messages =====
    client.on('message',(t,p)=>{
      const v = p.toString();
      if(t==='motor/rpm/left')  { updateChart(rpmLeft,v);  updateSpeedo(speedLeft, parseFloat(v)); }
      if(t==='motor/rpm/right') { updateChart(rpmRight,v); updateSpeedo(speedRight, parseFloat(v)); }
      if(t==='motor/pwm/left')  updateChart(pwmLeft,v);
      if(t==='motor/pwm/right') updateChart(pwmRight,v);
    });

    // ===== Voice Recognition =====
    function normalizeCommand(raw){
      let c=raw.trim().replace(/[.,?]$/,'').toUpperCase();
      const R={'SATU':'1','DUA':'2','TIGA':'3','BERHENTI':'STOP',
               'MAJU SATU':'MAJU 1','MAJU DUA':'MAJU 2','MAJU TIGA':'MAJU 3',
               'MUNDUR SATU':'MUNDUR 1','MUNDUR DUA':'MUNDUR 2','MUNDUR TIGA':'MUNDUR 3'};
      Object.entries(R).forEach(([k,v])=>{ if(c.includes(k)) c=c.replace(k,v); });
      return c;
    }
    function startVoiceRecognition(){
      const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ document.getElementById('speechOutput').textContent='Browser tidak mendukung Speech Recognition'; return; }
      const rec = new SR();
      rec.lang='id-ID'; rec.interimResults=false;
      rec.onresult = e => {
        const raw = e.results[0][0].transcript;
        const cmd = normalizeCommand(raw);
        document.getElementById('speechOutput').textContent = cmd;
        sendCommand(cmd);
      };
      rec.onerror = e => document.getElementById('speechOutput').textContent = `Error: ${e.error}`;
      rec.start();
    }

    // ===== Joystick Logic (dengan autocenter & arah belok benar) =====
    const joy = document.getElementById('joystick');
    const ctx = joy.getContext('2d');
    const S = joy.width, H = S/2, R = H-20;
    let drag = false;
    drawJoy(0,0);

    joy.addEventListener('pointerdown', e=>{ drag=true; joy.setPointerCapture(e.pointerId); updateJoy(e); });
    joy.addEventListener('pointermove', e=>{ if(drag) updateJoy(e); });
    joy.addEventListener('pointerup', e=>{ drag=false; resetJoy(); });
    joy.addEventListener('pointerleave', e=>{ if(drag){ drag=false; resetJoy(); } });
    joy.addEventListener('pointercancel', e=>{ drag=false; resetJoy(); });

    function updateJoy(e){
      const r = joy.getBoundingClientRect();
      let x = e.clientX - r.left - H;
      let y = e.clientY - r.top - H;
      const d = Math.hypot(x,y);
      if(d>R){ x=x/d*R; y=y/d*R; }
      drawJoy(x,y);
      const xn = +(x/R).toFixed(2);
      const yn = +(-(y/R).toFixed(2));
      document.getElementById('joystickStatus').textContent = `(${xn}, ${yn})`;
      // invert turn â†’ belok kanan saat xn>0
      const speed = Math.round(yn*3);
      const turn  = -Math.round(xn*3);
      publish(speed, turn);
    }

    function drawJoy(x,y){
      ctx.clearRect(0,0,S,S);
      ctx.beginPath(); ctx.arc(H,H,R+10,0,2*Math.PI);
      ctx.fillStyle='rgba(255,255,255,0.05)'; ctx.fill();
      ctx.beginPath(); ctx.arc(H+x, H+y, 20, 0,2*Math.PI);
      ctx.fillStyle='#fff'; ctx.fill();
      ctx.strokeStyle='#888'; ctx.lineWidth=3; ctx.stroke();
    }

    function resetJoy(){
      drawJoy(0,0);
      document.getElementById('joystickStatus').textContent = '(0, 0)';
      publish(0,0);
    }

    function publish(speed, turn){
      let L = speed - turn, Rm = speed + turn;
      L = Math.max(-3,Math.min(3,L));
      Rm = Math.max(-3,Math.min(3,Rm));
      function F(n){
        if(n===0) return 'STOP';
        return (n>0?'MAJU ':'MUNDUR ')+Math.abs(n);
      }
      sendCommand(`KIRI ${F(L)}`);
      sendCommand(`KANAN ${F(Rm)}`);
    }
  </script>
</body>
</html>
