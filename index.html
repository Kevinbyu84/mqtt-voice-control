```html
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kontrol Motor ESP32</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== Reset & Body ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      text-align: center;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px 0;
      width: 100%;
      font-size: 28px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      backdrop-filter: blur(6px);
      margin-bottom: 20px;
    }

    /* ===== Kontainer Motor & Grafik ===== */
    .motors-container {
      display: flex;
      justify-content: center;
      gap: 60px;
      flex-wrap: wrap;
      margin: 0 20px 40px 20px;
    }
    .motor-group {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 24px 30px;
      max-width: 360px;
      flex: 1 1 360px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid rgba(255,255,255,0.25);
    }
    .motor-group h2 {
      margin-bottom: 20px;
      font-size: 22px;
      font-weight: 700;
    }
    .speedometer-container {
      position: relative;
      width: 180px;
      height: 140px;
      margin-bottom: 32px;
    }
    .speedometer-label {
      position: absolute;
      bottom: 8px;
      width: 100%;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
    }
    .chart-container {
      width: 320px;
      height: 180px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 30px;
    }

    /* ===== Container Voice Command ===== */
    .voice-container {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 24px 30px;
      max-width: 780px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.25);
      margin-bottom: 40px;

      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .voice-command {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      width: 100%;
    }
    .voice-command button {
      background-color: #ffffff;
      color: #1e3c72;
      font-size: 16px;
      padding: 12px 24px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: background 0.2s ease;
    }
    .voice-command button:hover {
      background-color: #e3e3e3;
    }
    .speech-preview {
      font-size: 16px;
      background-color: rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 10px 20px;
      min-width: 180px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* ===== Container untuk Throttle ===== */
    .throttle-container {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 24px 30px;
      max-width: 780px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.25);
      margin-bottom: 40px;

      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 60px;
    }

    /* ===== Controls (Throttle) ===== */
    .controls {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      width: 100%;
    }
    .throttle-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      position: relative;
      flex: 1 1 300px;
    }
    .throttle-group label {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .throttle-wrapper {
      display: flex;
      align-items: center;
    }
    .throttle {
      writing-mode: bt-lr;
      -webkit-appearance: slider-vertical;
      width: 50px;   /* Lebar slider */
      height: 300px; /* Tinggi slider */
      background: transparent;
      margin: 0 12px;
    }
    .throttle-labels {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 300px; /* Harus sama dengan tinggi slider */
      font-size: 14px;
      line-height: 1.2;
      text-align: left;
      user-select: none;
    }
    .throttle-value {
      font-size: 16px;
      font-weight: 700;
      margin-top: 4px;
    }

    /* ===== Hover Button ===== */
    .controls button:hover {
      background-color: #e0e0e0;
    }
    .controls button:active {
      background-color: #c0c0c0;
    }

    /* ===== Responsif ke Layar Kecil ===== */
    @media (max-width: 800px) {
      .throttle-container {
        max-width: 360px;
        flex-direction: column;
        align-items: center;
      }
      .voice-container {
        max-width: 360px;
      }
      .controls {
        flex-direction: column;
        align-items: center;
        gap: 40px;
      }
      .throttle-group {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>

  <h1>ESP32 Motor Control Panel</h1>

  <!-- ===== Bagian Grafik Motor ===== -->
  <div class="motors-container">
    <!-- Motor Kiri -->
    <section class="motor-group" id="motor-left">
      <h2>Data Motor Kiri</h2>
      <div class="speedometer-container">
        <canvas id="speedometerLeft" width="180" height="140"></canvas>
        <div class="speedometer-label">RPM Kiri</div>
      </div>
      <div class="chart-container">
        <canvas id="rpmLeft"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="pwmLeft"></canvas>
      </div>
    </section>

    <!-- Motor Kanan -->
    <section class="motor-group" id="motor-right">
      <h2>Data Motor Kanan</h2>
      <div class="speedometer-container">
        <canvas id="speedometerRight" width="180" height="140"></canvas>
        <div class="speedometer-label">RPM Kanan</div>
      </div>
      <div class="chart-container">
        <canvas id="rpmRight"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="pwmRight"></canvas>
      </div>
    </section>
  </div>

  <!-- ===== Container untuk Voice Command ===== -->
  <div class="voice-container">
    <div class="voice-command">
      <button onclick="startVoiceRecognition()">ðŸŽ¤ Voice Command</button>
      <div id="speechOutput" class="speech-preview">...</div>
    </div>
  </div>

  <!-- ===== Container untuk Throttle ===== -->
  <div class="throttle-container">
    <div class="controls">
      <!-- Throttle Kiri -->
      <div class="throttle-group">
        <label for="throttleLeft">Throttle Kiri</label>
        <div class="throttle-wrapper">
          <input
            type="range"
            min="-3"
            max="3"
            value="0"
            id="throttleLeft"
            class="throttle"
            oninput="handleThrottleChange('left', this.value)"
          />
          <div class="throttle-labels">
            <div>MAJU 3</div>
            <div>MAJU 2</div>
            <div>MAJU 1</div>
            <div>STOP</div>
            <div>MUNDUR 1</div>
            <div>MUNDUR 2</div>
            <div>MUNDUR 3</div>
          </div>
        </div>
        <div class="throttle-value" id="throttleLeftValue">STOP</div>
      </div>

      <!-- Throttle Kanan -->
      <div class="throttle-group">
        <label for="throttleRight">Throttle Kanan</label>
        <div class="throttle-wrapper">
          <input
            type="range"
            min="-3"
            max="3"
            value="0"
            id="throttleRight"
            class="throttle"
            oninput="handleThrottleChange('right', this.value)"
          />
          <div class="throttle-labels">
            <div>MAJU 3</div>
            <div>MAJU 2</div>
            <div>MAJU 1</div>
            <div>STOP</div>
            <div>MUNDUR 1</div>
            <div>MUNDUR 2</div>
            <div>MUNDUR 3</div>
          </div>
        </div>
        <div class="throttle-value" id="throttleRightValue">STOP</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Inisialisasi MQTT =====
    const mqttOptions = {
      username: 'isp32',
      password: 'ISPsogem22',
      connectTimeout: 5000,
      clean: true,
      protocol: 'wss'
    };
    const client = mqtt.connect(
      'wss://7a3adf123d584eb0b1c891a0cb842c35.s1.eu.hivemq.cloud:8884/mqtt',
      mqttOptions
    );

    client.on('connect', () => {
      console.log('Terhubung ke MQTT');
      // Subscribe ke data sensor
      client.subscribe('motor/rpm/left');
      client.subscribe('motor/rpm/right');
      client.subscribe('motor/pwm/left');
      client.subscribe('motor/pwm/right');
      // Subscribe ke feedback throttle
      client.subscribe('motor/throttle/left');
      client.subscribe('motor/throttle/right');
    });

    function sendCommand(cmd) {
      client.publish('motor/mode_pid', cmd);
      console.log('Kirim:', cmd);
    }

    // ===== Fungsi untuk Memperbarui Grafik =====
    const createChart = (id, label) => {
      const ctx = document.getElementById(id).getContext('2d');
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: label,
            borderColor: '#ffffff',
            backgroundColor: 'rgba(255,255,255,0.2)',
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
            data: [],
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { display: false },
            y: { beginAtZero: true, ticks: { color: '#ffffff' } }
          },
          plugins: {
            legend: { labels: { color: '#ffffff' } }
          }
        }
      });
    };

    const rpmLeftChart = createChart('rpmLeft', 'RPM Kiri');
    const rpmRightChart = createChart('rpmRight', 'RPM Kanan');
    const pwmLeftChart = createChart('pwmLeft', 'PWM Kiri');
    const pwmRightChart = createChart('pwmRight', 'PWM Kanan');

    function updateChart(chart, value) {
      const now = new Date().toLocaleTimeString();
      chart.data.labels.push(now);
      chart.data.datasets[0].data.push(Number(value));
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    // ===== Speedometer Plugin =====
    const MAX_RPM = 100;
    const centerTextPlugin = {
      id: 'centerText',
      afterDraw(chart) {
        const { ctx, chartArea: { width, height } } = chart;
        ctx.save();
        ctx.font = 'bold 32px Segoe UI';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const value = chart.data.datasets[0].data[0];
        const text = value ? value.toFixed(0) : '0';
        ctx.fillText(text, width / 2, height / 1.7);
        ctx.restore();
      }
    };
    function createSpeedometer(id) {
      const ctx = document.getElementById(id).getContext('2d');
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Kecepatan', 'Sisa'],
          datasets: [{
            data: [0, MAX_RPM],
            backgroundColor: ['#ffffff', '#444'],
            borderWidth: 0,
            cutout: '80%',
            circumference: 180,
            rotation: 270,
            hoverOffset: 0
          }]
        },
        options: {
          responsive: false,
          animation: { duration: 300 },
          plugins: {
            tooltip: { enabled: false },
            legend: { display: false },
            centerText: {}
          }
        },
        plugins: [centerTextPlugin]
      });
    }

    const speedometerLeft = createSpeedometer('speedometerLeft');
    const speedometerRight = createSpeedometer('speedometerRight');
    function updateSpeedometer(chart, rpm) {
      rpm = Math.max(0, Math.min(MAX_RPM, rpm));
      chart.data.datasets[0].data[0] = rpm;
      chart.data.datasets[0].data[1] = MAX_RPM - rpm;
      chart.update();
    }

    client.on('message', (topic, payload) => {
      const value = payload.toString();

      // â€” Update grafik (tetap sama) â€”
      if (topic === 'motor/rpm/left') {
        updateChart(rpmLeftChart, parseFloat(value));
        updateSpeedometer(speedometerLeft, parseFloat(value));
      }
      else if (topic === 'motor/rpm/right') {
        updateChart(rpmRightChart, parseFloat(value));
        updateSpeedometer(speedometerRight, parseFloat(value));
      }
      else if (topic === 'motor/pwm/left') {
        updateChart(pwmLeftChart, parseFloat(value));
      }
      else if (topic === 'motor/pwm/right') {
        updateChart(pwmRightChart, parseFloat(value));
      }

      // â€” Feedback throttle: ubah posisi slider dan teksnya â€”
      else if (topic === 'motor/throttle/left') {
        const levelL = parseInt(value);
        const sliderL = document.getElementById('throttleLeft');
        sliderL.value = levelL;
        document.getElementById('throttleLeftValue').textContent = convertLevelToText(levelL);
      }
      else if (topic === 'motor/throttle/right') {
        const levelR = parseInt(value);
        const sliderR = document.getElementById('throttleRight');
        sliderR.value = levelR;
        document.getElementById('throttleRightValue').textContent = convertLevelToText(levelR);
      }
    });

    // ===== Utility & Voice Recognition =====
    function convertLevelToText(level) {
      const absLvl = Math.abs(level);
      if (level === 0) return "STOP";
      if (level > 0) {
        return `MAJU ${absLvl}`;
      } else {
        return `MUNDUR ${absLvl}`;
      }
    }

    function normalizeCommand(raw) {
      let cmd = raw.trim().replace(/[.,?]$/, '');
      cmd = cmd.toUpperCase();
      const replacements = {
        "SATU": "1",
        "DUA": "2",
        "TIGA": "3",
        "MAJU SATU": "MAJU 1",
        "MAJU DUA": "MAJU 2",
        "MAJU TIGA": "MAJU 3",
        "MUNDUR SATU": "MUNDUR 1",
        "MUNDUR DUA": "MUNDUR 2",
        "MUNDUR TIGA": "MUNDUR 3",
        "BERHENTI": "STOP"
      };
      for (const [key, value] of Object.entries(replacements)) {
        if (cmd.includes(key)) {
          cmd = cmd.replace(key, value);
        }
      }
      return cmd;
    }

    function startVoiceRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        document.getElementById('speechOutput').textContent = 'Browser tidak mendukung Speech Recognition';
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'id-ID';
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        const raw = event.results[0][0].transcript;
        const command = normalizeCommand(raw);
        document.getElementById('speechOutput').textContent = command;
        sendCommand(command);
      };

      recognition.onerror = (event) => {
        document.getElementById('speechOutput').textContent = `Error: ${event.error}`;
      };
      recognition.start();
    }

    // ===== Fungsi Handle Throttle Input =====
    function handleThrottleChange(side, level) {
      const directions = {
        "-3": "MUNDUR 3",
        "-2": "MUNDUR 2",
        "-1": "MUNDUR 1",
        "0":  "STOP",
        "1":  "MAJU 1",
        "2":  "MAJU 2",
        "3":  "MAJU 3"
      };
      const direction = directions[level] || "STOP";

      // Prefix KIRI / KANAN
      const prefix = (side === 'left')  ? 'KIRI'
                   : (side === 'right') ? 'KANAN'
                   : side.toUpperCase();

      const command = `${prefix} ${direction}`; // Contoh: "KIRI MAJU 2"

      // Update teks di bawah slider
      const elemId = `throttle${side.charAt(0).toUpperCase() + side.slice(1)}Value`;
      document.getElementById(elemId).textContent = direction;

      // Kirim perintah ke broker
      sendCommand(command);
    }
  </script>
</body>
</html>
```
