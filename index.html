<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Kontrol Motor ESP32 dengan MQTT dan Suara</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    .charts {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .chart-container {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      width: 300px;
      height: 150px;
    }

    .voice-command {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 20px auto;
    }

    .voice-command button {
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .speech-preview {
      font-size: 16px;
      padding: 10px 15px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      min-width: 200px;
    }

    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      text-align: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .controls button {
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      background-color: #1976d2;
      color: white;
      cursor: pointer;
      min-width: 110px;
    }

    .controls button:hover {
      background-color: #1565c0;
    }
  </style>
</head>
<body>

<h1>ESP32 Motor Control Panel</h1>

<div class="charts">
  <div class="chart-container"><canvas id="rpmLeft"></canvas></div>
  <div class="chart-container"><canvas id="rpmRight"></canvas></div>
  <div class="chart-container"><canvas id="pwmLeft"></canvas></div>
  <div class="chart-container"><canvas id="pwmRight"></canvas></div>
</div>

<div class="voice-command">
  <button onclick="startVoiceRecognition()">ðŸŽ¤ Voice Command</button>
  <div id="speechOutput" class="speech-preview">...</div>
</div>

<div class="controls">
  <div class="control-group">
    <button onclick="sendCommand('MAJU 1')">MAJU 1</button>
    <button onclick="sendCommand('MAJU 2')">MAJU 2</button>
    <button onclick="sendCommand('MAJU 3')">MAJU 3</button>
    <button onclick="sendCommand('MAJU KIRI')">MAJU KIRI</button>
    <button onclick="sendCommand('MAJU KANAN')">MAJU KANAN</button>
  </div>
  <div class="control-group">
    <button onclick="sendCommand('STOP')">STOP</button>
    <button onclick="sendCommand('PUTAR KIRI')">PUTAR KIRI</button>
    <button onclick="sendCommand('PUTAR KANAN')">PUTAR KANAN</button>
  </div>
  <div class="control-group">
    <button onclick="sendCommand('MUNDUR 1')">MUNDUR 1</button>
    <button onclick="sendCommand('MUNDUR 2')">MUNDUR 2</button>
    <button onclick="sendCommand('MUNDUR 3')">MUNDUR 3</button>
    <button onclick="sendCommand('MUNDUR KIRI')">MUNDUR KIRI</button>
    <button onclick="sendCommand('MUNDUR KANAN')">MUNDUR KANAN</button>
  </div>
</div>

<script>
  const mqttOptions = {
    username: 'isp32',
    password: 'ISPsogem22',
    connectTimeout: 5000,
    clean: true,
    protocol: 'wss'
  };

  const client = mqtt.connect('wss://7a3adf123d584eb0b1c891a0cb842c35.s1.eu.hivemq.cloud:8884/mqtt', mqttOptions);

  client.on('connect', () => {
    console.log('Terhubung ke MQTT');
    client.subscribe('motor/rpm/left');
    client.subscribe('motor/rpm/right');
    client.subscribe('motor/pwm/left');
    client.subscribe('motor/pwm/right');
  });

  function sendCommand(cmd) {
    console.log("Kirim:", cmd);
    client.publish('motor/mode_pid', cmd);
  }

  const createChart = (id, label) => {
    const ctx = document.getElementById(id).getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: label,
          borderColor: 'blue',
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
          data: [],
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { display: false },
          y: { beginAtZero: true }
        }
      }
    });
  };

  const rpmLeftChart = createChart('rpmLeft', 'RPM Kiri');
  const rpmRightChart = createChart('rpmRight', 'RPM Kanan');
  const pwmLeftChart = createChart('pwmLeft', 'PWM Kiri');
  const pwmRightChart = createChart('pwmRight', 'PWM Kanan');

  function updateChart(chart, value) {
    const time = new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(Number(value));
    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }

  client.on('message', (topic, payload) => {
    const value = parseFloat(payload.toString());
    if (topic === 'motor/rpm/left') updateChart(rpmLeftChart, value);
    else if (topic === 'motor/rpm/right') updateChart(rpmRightChart, value);
    else if (topic === 'motor/pwm/left') updateChart(pwmLeftChart, value);
    else if (topic === 'motor/pwm/right') updateChart(pwmRightChart, value);
  });

  function normalizeCommand(raw) {
    let cmd = raw.toUpperCase().trim();

    const replacements = {
      "SATU": "1", "DUA": "2", "TIGA": "3",
      "MAJU SATU": "MAJU 1",
      "MAJU DUA": "MAJU 2",
      "MAJU TIGA": "MAJU 3",
      "MUNDUR SATU": "MUNDUR 1",
      "MUNDUR DUA": "MUNDUR 2",
      "MUNDUR TIGA": "MUNDUR 3",
      "BERHENTI": "STOP"
    };

    for (const [key, value] of Object.entries(replacements)) {
      if (cmd.includes(key)) {
        cmd = cmd.replace(key, value);
      }
    }

    return cmd;
  }

  function startVoiceRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      document.getElementById('speechOutput').textContent = 'Browser tidak mendukung Speech Recognition';
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'id-ID';
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const raw = event.results[0][0].transcript;
      const command = normalizeCommand(raw);
      document.getElementById('speechOutput').textContent = command;
      sendCommand(command);
    };

    recognition.onerror = (event) => {
      document.getElementById('speechOutput').textContent = `Error: ${event.error}`;
    };

    recognition.start();
  }
</script>

</body>
</html>
